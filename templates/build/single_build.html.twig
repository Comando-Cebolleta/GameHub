{% extends 'base.html.twig' %}

{% block title %}Build - {{ build ? build.getNombre() : 'No encontrada' }}{% endblock %}

{% block stylesheets %}
    <link rel="stylesheet" href="{{ asset('css/styleSingleBuild.css') }}">
{% endblock %}

{% block body %}
    {% include 'partials/header.html.twig' with {'iconColor': 'GOLD'} %}
    {% set statsPlanas = ['HP', 'ATK', 'DEF', 'SPD', 'EM'] %}

    <div class="build-view-container">
        {% if build is not null %}

            <header class="build-header">
                <div class="char-image-container">
                    <img src="{{ asset('assets/personajes/' ~ build.getPersonajePlantilla().getImagen()) }}" alt="Imagen de {{ build.getPersonajePlantilla().getNombre() }}">
                </div>
                <div class="build-info">
                    <h1>{{ build.getNombre() }}</h1>
                    <p><strong>Personaje:</strong> {{ build.getPersonajePlantilla().getNombre() }}</p>
                    <p><strong>Nivel:</strong> {{ build.getNivel() }}</p>
                    <p><strong>Dupes:</strong> {{ build.getDupeNum() }}</p>
                </div>
            </header>

            <section class="section-block">
                <h2 class="section-title">Armamento</h2>
                <table class="modern-table">
                    <thead>
                    <tr>
                        <th>Arma</th>
                        <th>Nivel</th>
                        <th>Imagen</th>
                        <th>Estadísticas</th>
                        <th>Pasiva</th>
                        <th>Tipo</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr>
                        <td>{{ build.getArma().getArmaPlantilla().getNombre() }}</td>
                        <td>{{ build.getArma().getNivel() }}</td>
                        <td>
                            {% if build.getArma() %}
                                <img src="{{ asset('assets/armas/' ~ build.getArma().getArmaPlantilla().getImagen()) }}" alt="Imagen del arma" class="table-img">
                            {% else %}
                                <span class="empty-text">Sin arma</span>
                            {% endif %}
                        </td>
                        <td>
                            <ul class="stats-list">
                                {% for nombreStat, valor in build.getArma().getStatsCalculados() %}
                                    <li>
                                        <strong>{{ diccionarioStats[nombreStat] ?? nombreStat }}:</strong>
                                        {% if nombreStat in statsPlanas %}
                                            {{ valor|number_format(0) }}
                                        {% else %}
                                            {{ (valor * 100)|number_format(1) }}%
                                        {% endif %}
                                    </li>
                                {% endfor %}
                            </ul>
                        </td>
                        <td>{{ build.getArma().getArmaPlantilla().getPasiva() }}</td>
                        <td>{{ build.getArma().getArmaPlantilla().getTipo() }}</td>
                    </tr>
                    </tbody>
                </table>
            </section>

            <section class="section-block">
                <h2 class="section-title">Estadísticas Totales</h2>
                <div class="total-stats-grid">
                    {% for nombreStat, valor in build.getStatsCalculados() %}
                        <div class="stat-card">
                            <strong>{{ diccionarioStats[nombreStat] ?? nombreStat }}:</strong>
                            {% if nombreStat in statsPlanas %}
                                {{ valor|number_format(0) }}
                            {% else %}
                                {{ (valor * 100)|number_format(1) }}%
                            {% endif %}
                        </div>
                    {% endfor %}
                </div>
            </section>

            <section class="section-block">
                <h2 class="section-title">Artefactos / Reliquias</h2>
                <table class="modern-table">
                    <thead>
                    <tr>
                        <th>Imagen</th>
                        <th>Pieza</th>
                        <th>Conjunto</th>
                        <th>Estadísticas</th>
                        <th>Bonificaciones</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for artefacto in build.getArtefactos() %}
                        <tr>
                            <td>
                                {% if artefacto %}
                                    <img src="{{ asset('assets/artefactos/' ~ artefacto.getArtefactoPlantilla().getImagen()) }}" alt="Artefacto" class="table-img">
                                {% else %}
                                    <span class="empty-text">Vacío</span>
                                {% endif %}
                            </td>
                            <td>{{ artefacto.getArtefactoPlantilla().getPiezaTipo().getNombre() }}</td>
                            <td>{{ artefacto.getArtefactoPlantilla().getSetArtefactos().getNombre() }}</td>
                            <td>
                                {% set stats = artefacto.getEstadisticas() %}
                                <ul class="stats-list">
                                    {% if stats.main_stat is defined %}
                                        <li class="main-stat">
                                            {{ diccionarioStats[stats.main_stat.name] ?? stats.main_stat.name }}:
                                            {% if stats.main_stat.name in statsPlanas %}
                                                {{ stats.main_stat.value|number_format(0) }}
                                            {% else %}
                                                {{ (stats.main_stat.value * 100)|number_format(1) }}%
                                            {% endif %}
                                        </li>
                                    {% endif %}

                                    {% if stats.sub_stats is defined %}
                                        {% for sub in stats.sub_stats %}
                                            <li>
                                                {{ diccionarioStats[sub.name] ?? sub.name }}:
                                                {% if sub.name in statsPlanas %}
                                                    +{{ sub.value|number_format(0) }}
                                                {% else %}
                                                    +{{ (sub.value * 100)|number_format(1) }}%
                                                {% endif %}
                                            </li>
                                        {% endfor %}
                                    {% endif %}
                                </ul>
                            </td>
                            <td>{{ artefacto.getArtefactoPlantilla().getSetArtefactos().getEfectos() }}</td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </section>

            <section class="section-block">
                <h2 class="section-title">Habilidades</h2>
                {% if build.getPersonajePlantilla().getHabilidades() is not empty %}
                    <table class="modern-table">
                        <thead>
                        <tr>
                            <th>Nombre</th>
                            <th>Efectos</th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for habilidad in build.getPersonajePlantilla().getHabilidades() %}
                            <tr>
                                <td class="habilidad-nombre">{{ habilidad.getNombre() }}</td>
                                <td>{{ habilidad.getEfectos() }}</td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                {% else %}
                    <p class="empty-text">No hay habilidades registradas para este personaje.</p>
                {% endif %}
            </section>

            <footer class="build-footer">
                <a href="{{ path('app_profile', {'id': build.getUser().getId()}) }}" class="creator-link">
                    &commat; Creado por: {{ build.getUser().getUsername() }}
                </a>
            </footer>

        {% else %}
            <div class="error-container">
                <p>No se ha encontrado esa build.</p>
                <a href="{{ path('home') }}" class="back-link">Volver al inicio</a>
            </div>
        {% endif %}
    </div>
{% endblock %}