{% extends 'base.html.twig' %}

{% block title %}Nueva Build Honkai - GameHub{% endblock %}

{% block stylesheets %}
    <link rel="stylesheet" href="{{ asset('css/styleBlogHONKAI.css') }}">
    <link rel="stylesheet" href="{{ asset('css/styleBuildHSR.css') }}">

    <style>
        /* --- AJUSTES DINÁMICOS DEL HEADER (ESTILO HSR) --- */
        header .login-container {
            display: flex;
            align-items: center;
            gap: 15px;
            background: transparent !important;
            border: none !important;
            box-shadow: none !important;
            padding: 0 !important;
            width: auto !important;
        }

        .user-info {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            text-align: right;
        }

        .welcome-text {
            color: #c0c0c0; /* Plateado HSR */
            font-weight: bold;
            font-size: 0.9rem;
        }

        .logout-link {
            color: #ffffff;
            font-size: 0.75rem;
            text-decoration: underline !important;
            opacity: 0.7;
        }

        .logout-link:hover {
            opacity: 1;
            color: #ffadad;
        }

        /* Separador específico para HSR */
        .hr-hsr {
            border: 0;
            height: 1px;
            background-image: linear-gradient(to right, rgba(255, 255, 255, 0), rgba(255, 255, 255, 0.75), rgba(255, 255, 255, 0));
            margin: 20px 0;
        }
    </style>
{% endblock %}

{% block body %}
    {% set is_edit = is_edit|default(false) %}
    {# INCLUSIÓN DEL HEADER MODULAR - Forzamos el icono SILVER #}
    {% include 'partials/header.html.twig' with {'iconColor': 'SILVER'} %}

    <main>
        <div class="container">
            <h2 class="build-title">
                {% if is_edit %}
                    Editar Configuración - HSR
                {% else %}
                    Configurar Nueva Build - HSR
                {% endif %}
            </h2>

            {# Añadimos ID al formulario para consistencia #}
            {{ form_start(form, {'attr': {'id': 'form-build-hsr'}}) }}
            <div class="build-grid">

                {# COLUMNA IZQUIERDA: DATOS BÁSICOS #}
                <div class="col-left">
                    <div class="build-section-card">
                        <h4 class="section-subtitle">Personaje y Arma</h4>
                        {{ form_row(form.nombre) }}
                        
                        {# Añadimos la clase 'personaje-selector' para que el JS la detecte #}
                        {{ form_row(form.personajePlantilla, {'attr': {'class': 'form-select personaje-selector'}}) }}
                        
                        <div class="subgrid">
                            {{ form_row(form.nivel) }}
                            {{ form_row(form.dupeNum) }}
                        </div>
                        <hr>
                        
                        {# Añadimos la clase 'arma-selector' para que el JS la detecte #}
                        {{ form_row(form.arma) }}

                        <hr>
                        <h4 class="section-subtitle">Habilidades (Rastros)</h4>
                        
                        {# Estructura Híbrida para Habilidades (Igual que en Genshin) #}
                        <div id="habilidades-container" data-prototype="{{ form_widget(form.personajeHabilidades.vars.prototype)|e('html_attr') }}">
                             {# Recorremos las habilidades existentes (Modo Edición) #}
                            {% for field in form.personajeHabilidades %}
                                <div class="grupo-habilidad" style="margin-bottom: 10px;">
                                    {% set habilidadEntidad = field.vars.value.habilidad %}
                                    
                                    <label style="display:block; margin-bottom: 5px; color: #ffffff;">
                                        {% if habilidadEntidad %}
                                            {{ habilidadEntidad.nombre }}
                                        {% else %}
                                            Habilidad #{{ loop.index }}
                                        {% endif %}
                                    </label>

                                    {{ form_widget(field.nivel) }}
                                    {{ form_widget(field.habilidad) }}
                                    {{ form_errors(field) }}
                                </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>

                {# COLUMNA DERECHA: RELIQUIAS Y ORNAMENTOS #}
                <div class="col-right">
                    <div class="build-section-card">
                        
                        {# --- BLOQUE 1: RELIQUIAS (4 Piezas) --- #}
                        <h4 class="section-subtitle">Reliquias Cavernosas</h4>
                        <div class="grid-botones-artefactos">
                            <button type="button" class="btn-modal-artefactos hsr" data-artefacto="cabeza">+ Añadir Cabeza <img src=""/></button>
                            <button type="button" class="btn-modal-artefactos hsr" data-artefacto="manos">+ Añadir Manos <img src=""/></button>
                            <button type="button" class="btn-modal-artefactos hsr" data-artefacto="torso">+ Añadir Torso <img src=""/></button>
                            <button type="button" class="btn-modal-artefactos hsr" data-artefacto="pies">+ Añadir Pies <img src=""/></button>
                        </div>

                        {# Separador visual solicitado #}
                        <hr class="hr-hsr">

                        {# --- BLOQUE 2: ORNAMENTOS (2 Piezas) --- #}
                        <h4 class="section-subtitle">Ornamentos Planares</h4>
                        <div class="grid-botones-artefactos">
                            <button type="button" class="btn-modal-artefactos hsr" data-artefacto="esfera">+ Añadir Esfera <img src=""/></button>
                            <button type="button" class="btn-modal-artefactos hsr" data-artefacto="cuerda">+ Añadir Cuerda <img src=""/></button>
                        </div>

                        {# --- DEFINICIÓN DE MODALES (Para las 6 piezas) --- #}
                        {% set piezas = [
                            {'id': 'cabeza', 'titulo': 'Cabeza', 'form': form.reliquia_cabeza},
                            {'id': 'manos', 'titulo': 'Manos', 'form': form.reliquia_manos},
                            {'id': 'torso', 'titulo': 'Torso', 'form': form.reliquia_torso},
                            {'id': 'pies', 'titulo': 'Pies', 'form': form.reliquia_pies},
                            {'id': 'esfera', 'titulo': 'Esfera Planar', 'form': form.ornamento_esfera},
                            {'id': 'cuerda', 'titulo': 'Cuerda de Unión', 'form': form.ornamento_cuerda}
                        ] %}

                        {% for pieza in piezas %}
                            <div id="modal-{{ pieza.id }}" class="modal-artefacto-overlay">
                                <div class="modal-artefacto-content">
                                    <span class="btn-cerrar-modal">&times;</span>
                                    
                                    <h3>{{ pieza.titulo }}</h3>

                                    <div class="layout-horizontal">
                                        {# COLUMNA IZQUIERDA #}
                                        <div class="col-main-info">
                                            <h4 class="col-title">Stat Principal</h4>
                                            
                                            <div class="input-group-compact">
                                                <label>Set de Artefactos</label>
                                                {# Importante: clase 'artefacto-set-select' para el JS #}
                                                {{ form_widget(pieza.form.setSeleccionado, {'attr': {'class': 'artefacto-set-select', 'data-artefacto': pieza.id}}) }}
                                            </div>

                                            <div class="input-group-compact">
                                                <label>Main Stat</label>
                                                {{ form_widget(pieza.form.statPrincipalNombre) }}
                                            </div>

                                            <div class="input-group-compact">
                                                <label>Valor</label>
                                                {{ form_widget(pieza.form.statPrincipalValor) }}
                                            </div>
                                        </div>

                                        {# COLUMNA DERECHA: SUBSTATS #}
                                        <div class="col-substats">
                                            <h4 class="col-title" style="grid-column: span 2;">Sub-Stats</h4>
                                            
                                            {# Iteramos 1 a 4 para substats #}
                                            <div class="input-group-compact">
                                                <label>Sub 1</label>
                                                {{ form_widget(pieza.form.subStatNombre1) }}
                                                {{ form_widget(pieza.form.subStatValor1, {'attr': {'placeholder': 'Valor', 'style': 'margin-top:5px'}}) }}
                                            </div>
                                            <div class="input-group-compact">
                                                <label>Sub 2</label>
                                                {{ form_widget(pieza.form.subStatNombre2) }}
                                                {{ form_widget(pieza.form.subStatValor2, {'attr': {'placeholder': 'Valor', 'style': 'margin-top:5px'}}) }}
                                            </div>
                                            <div class="input-group-compact">
                                                <label>Sub 3</label>
                                                {{ form_widget(pieza.form.subStatNombre3) }}
                                                {{ form_widget(pieza.form.subStatValor3, {'attr': {'placeholder': 'Valor', 'style': 'margin-top:5px'}}) }}
                                            </div>
                                            <div class="input-group-compact">
                                                <label>Sub 4</label>
                                                {{ form_widget(pieza.form.subStatNombre4) }}
                                                {{ form_widget(pieza.form.subStatValor4, {'attr': {'placeholder': 'Valor', 'style': 'margin-top:5px'}}) }}
                                            </div>
                                        </div>
                                    </div>

                                    <button type="button" class="btn-guardar-modal">Confirmar Pieza</button>
                                </div>
                            </div>
                        {% endfor %}

                    </div>
                </div>

            </div>

            <div style="margin-top: 30px;">
                <button type="submit" class="btn-save-build w-100">
                    {% if is_edit %}Actualizar Datos{% else %}Guardar Build del Trazacaminos{% endif %}
                </button>
            </div>
            {{ form_end(form) }}
        </div>
    </main>

    <footer>
        Game Hub &copy; 2025-2026
    </footer>

    {% block javascripts %}
        {{ parent() }}
        <script type="text/javascript" src="{{ asset('js/filtroArmaPersonaje.js') }}"></script>
        <script type="text/javascript" src="{{ asset('js/habilidadesPersonaje.js') }}"></script>
        <script type="text/javascript" src="{{ asset('js/filtroArtefactos.js') }}"></script>
        <script type="text/javascript" src="{{ asset('js/imagenesBuild.js') }}"></script>
        <script type="text/javascript" src="{{ asset('js/alertaModals.js') }}"></script>
    {% endblock %}
    
{% endblock %}