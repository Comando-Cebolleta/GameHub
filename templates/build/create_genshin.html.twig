{% extends 'base.html.twig' %}

{% block title %}Nueva Build Genshin - GameHub{% endblock %}

{% block stylesheets %}
    {# Importamos el base de Genshin y el específico de la build #}
    <link rel="stylesheet" href="{{ asset('css/styleBlogGENSHIN.css') }}">
    <link rel="stylesheet" href="{{ asset('css/styleBuildGenshin.css') }}">

    <style>
        /* --- AJUSTES DINÁMICOS DEL HEADER (ESTILO GENSHIN) --- */
        header .login-container {
            display: flex;
            align-items: center;
            gap: 15px;
            background: transparent !important;
            border: none !important;
            box-shadow: none !important;
            padding: 0 !important;
            width: auto !important;
        }

        .user-info {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            text-align: right;
        }

        .welcome-text {
            color: #c2b46c; /* Dorado Genshin */
            font-weight: bold;
            font-size: 0.9rem;
        }

        .logout-link {
            color: #ffffff;
            font-size: 0.75rem;
            text-decoration: underline !important;
            opacity: 0.7;
        }

        .logout-link:hover {
            opacity: 1;
            color: #ffadad;
        }
    </style>
{% endblock %}

{% block body %}
    {% set is_edit = is_edit|default(false) %}
    {# INCLUSIÓN DEL HEADER MODULAR - Usamos GOLD por defecto para Genshin #}
    {% include 'partials/header.html.twig' with {'iconColor': 'GOLD'} %}

    <main>
        <div class="container">
            <h2 class="build-title-genshin">
                {% if is_edit %}
                    Editar Build: {{ form.vars.value.nombre }}
                {% else %}
                    Nueva Build: Genshin Impact
                {% endif %}
            </h2>

            {{ form_start(form, {'attr': {'id': 'form-build-genshin'}}) }}
            <div class="build-grid">

                {# BLOQUE PERSONAJE #}
                <div class="col-left">
                    <div class="build-section-card">
                        <h4 class="section-subtitle">Datos del Personaje</h4>
                        {{ form_row(form.nombre) }}
                        {{ form_row(form.personajePlantilla) }}
                        <div style="display: flex; gap: 10px;">
                            <div style="flex: 1;">{{ form_row(form.nivel) }}</div>
                            <div style="flex: 1;">{{ form_row(form.dupeNum) }}</div>
                        </div>
                        <hr>
                        <h4 class="section-subtitle">Arma Equipada</h4>
                        {{ form_row(form.arma) }}

                        <hr>
                        <h4 class="section-subtitle">Habilidades</h4>
                        <div id="habilidades-container" 
                            data-prototype="{{ form_widget(form.personajeHabilidades.vars.prototype)|e('html_attr') }}">
                            
                            {# Recorremos las habilidades existentes #}
                            {% for field in form.personajeHabilidades %}
                                
                                <div class="grupo-habilidad" style="margin-bottom: 10px;">
                                    {% set habilidadEntidad = field.vars.value.habilidad %}
                                    
                                    <label style="display:block; margin-bottom: 5px; color: #ffffff;">
                                        {% if habilidadEntidad %}
                                            {{ habilidadEntidad.nombre }}
                                        {% else %}
                                            Habilidad #{{ loop.index }}
                                        {% endif %}
                                    </label>

                                    {{ form_widget(field.nivel) }}

                                    {{ form_widget(field.habilidad) }}
                                    
                                    {{ form_errors(field) }}
                                </div>

                            {% endfor %}
                            
                        </div>
                    </div>
                </div>

                {# BLOQUE ARTEFACTOS #}
                <div class="col-right">
                    <div class="build-section-card">
                        <h4 class="section-subtitle">Conjunto de Artefactos</h4>
                        <div class="subgrid-artefactos">
                            <div class="grid-botones-artefactos">
                                <button type="button" class="btn-modal-artefactos" data-artefacto="pluma">+ Añadir Pluma <img src=""/></button>
                                <button type="button" class="btn-modal-artefactos" data-artefacto="flor">+ Añadir Flor <img src=""/></button>
                                <button type="button" class="btn-modal-artefactos" data-artefacto="reloj">+ Añadir Reloj <img src=""/></button>
                                <button type="button" class="btn-modal-artefactos" data-artefacto="caliz">+ Añadir Cáliz <img src=""/></button>
                                <button type="button" class="btn-modal-artefactos" data-artefacto="sombrero">+ Añadir Tiara <img src=""/></button>
                            </div>
                            
                            {% set piezas = [
                                {'id': 'flor', 'titulo': 'Flor de la Vida', 'form': form.artefacto_flor},
                                {'id': 'pluma', 'titulo': 'Pluma de la Muerte', 'form': form.artefacto_pluma},
                                {'id': 'reloj', 'titulo': 'Arenas del Eón', 'form': form.artefacto_reloj},
                                {'id': 'caliz', 'titulo': 'Cáliz de Eonothem', 'form': form.artefacto_copa},
                                {'id': 'sombrero', 'titulo': 'Tiara de Logos', 'form': form.artefacto_casco}
                            ] %}

                            {% for pieza in piezas %}
                                <div id="modal-{{ pieza.id }}" class="modal-artefacto-overlay">
                                    <div class="modal-artefacto-content">
                                        <span class="btn-cerrar-modal">&times;</span>
                                        
                                        <h3>{{ pieza.titulo }}</h3>

                                        {# INICIO DEL LAYOUT HORIZONTAL #}
                                        <div class="layout-horizontal">
                                            
                                            {# COLUMNA IZQUIERDA: SET Y STAT PRINCIPAL #}
                                            <div class="col-main-info">
                                                <h4 class="col-title">Stat Principal</h4>
                                                
                                                <div class="input-group-compact">
                                                    <label>Set de Artefactos</label>
                                                    {{ form_widget(pieza.form.setSeleccionado, {'attr': {'data-artefacto': pieza.id}}) }}
                                                </div>

                                                <div class="input-group-compact">
                                                    <label>Atributo Principal</label>
                                                    {{ form_widget(pieza.form.statPrincipalNombre) }}
                                                </div>

                                                <div class="input-group-compact">
                                                    <label>Valor</label>
                                                    {{ form_widget(pieza.form.statPrincipalValor) }}
                                                </div>
                                            </div>

                                            {# COLUMNA DERECHA: SUBSTATS (GRID 2x2) #}
                                            <div class="col-substats">
                                                {# Ponemos un título invisible o decorativo para alinear si quieres #}
                                                <h4 class="col-title" style="grid-column: span 2;">Sub-Stats</h4>

                                                {# Substat 1 #}
                                                <div class="input-group-compact">
                                                    <label>Substat 1</label>
                                                    {{ form_widget(pieza.form.subStatNombre1) }}
                                                    {{ form_widget(pieza.form.subStatValor1, {'attr': {'placeholder': 'Valor', 'style': 'margin-top:5px'}}) }}
                                                </div>

                                                {# Substat 2 #}
                                                <div class="input-group-compact">
                                                    <label>Substat 2</label>
                                                    {{ form_widget(pieza.form.subStatNombre2) }}
                                                    {{ form_widget(pieza.form.subStatValor2, {'attr': {'placeholder': 'Valor', 'style': 'margin-top:5px'}}) }}
                                                </div>

                                                {# Substat 3 #}
                                                <div class="input-group-compact">
                                                    <label>Substat 3</label>
                                                    {{ form_widget(pieza.form.subStatNombre3) }}
                                                    {{ form_widget(pieza.form.subStatValor3, {'attr': {'placeholder': 'Valor', 'style': 'margin-top:5px'}}) }}
                                                </div>

                                                {# Substat 4 #}
                                                <div class="input-group-compact">
                                                    <label>Substat 4</label>
                                                    {{ form_widget(pieza.form.subStatNombre4) }}
                                                    {{ form_widget(pieza.form.subStatValor4, {'attr': {'placeholder': 'Valor', 'style': 'margin-top:5px'}}) }}
                                                </div>
                                            </div>
                                        </div>
                                        {# FIN LAYOUT HORIZONTAL #}

                                        <button type="button" class="btn-guardar-modal">Confirmar Artefacto</button>
                                    </div>
                                </div>
                            {% endfor %}

                        </div>
                    </div>
                </div>

            </div>

            <button type="submit" class="btn-save-genshin">
                {% if is_edit %}Guardar Cambios{% else %}Forjar Nueva Build{% endif %}
            </button>
            {{ form_end(form) }}
        </div>
    </main>

    <footer>
        Game Hub &copy; 2025-2026
    </footer>
    {% block javascripts %}
        {{ parent() }}
        <script type="text/javascript" src="{{ asset('js/filtroArmaPersonaje.js') }}"></script>
        <script type="text/javascript" src="{{ asset('js/filtroArtefactos.js') }}"></script>
        <script type="text/javascript" src="{{ asset('js/imagenesBuild.js') }}"></script>
        <script type="text/javascript" src="{{ asset('js/alertaModals.js') }}"></script>
    {% endblock %}

{% endblock %}