{% extends 'base.html.twig' %}

{% block title %}Nuevo Post {{ juego == 'hsr' ? 'HSR' : 'Genshin' }} - GameHub{% endblock %}

{% block stylesheets %}
    {# Cargamos el CSS base (fondos, fuentes de juego) dinámicamente #}
    {% if juego == 'hsr' %}
        <link rel="stylesheet" href="{{ asset('css/styleBlogHONKAI.css') }}">
    {% else %}
        <link rel="stylesheet" href="{{ asset('css/styleBlogGENSHIN.css') }}">
    {% endif %}

    {# El CSS del formulario se mantiene fijo #}
    <link rel="stylesheet" href="{{ asset('css/styleFormPost.css') }}">

    <style>
        /* Ajuste de color del botón y bordes según el juego */
        .btn-submit {
            background: {{ juego == 'hsr' ? '#3a2a4b' : '#4a5d4e' }};
            border-color: {{ juego == 'hsr' ? '#c0c0c0' : '#e0c080' }};
        }
        .container {
            border-color: {{ juego == 'hsr' ? '#c0c0c0' : '#e0c080' }};
        }

        /* --- AJUSTES DINÁMICOS DEL HEADER PARA EL USUARIO --- */
        header .login-container {
            display: flex;
            align-items: center;
            gap: 15px;
            background: transparent !important;
            border: none !important;
            box-shadow: none !important;
            padding: 0 !important;
            width: auto !important;
        }

        .user-info {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            text-align: right;
        }

        .welcome-text {
            /* Plata para HSR, Dorado para Genshin */
            color: {{ juego == 'hsr' ? '#c0c0c0' : '#c2b46c' }};
            font-weight: bold;
            font-size: 0.9rem;
        }

        .logout-link {
            color: #ffffff;
            font-size: 0.75rem;
            text-decoration: underline !important;
            opacity: 0.7;
        }

        .logout-link:hover {
            opacity: 1;
            color: #ffadad;
        }
    </style>
{% endblock %}

{% block body %}
    {# INCLUSIÓN DEL HEADER MODULAR DINÁMICO #}
    {# Enviamos SILVER si es HSR, de lo contrario usará GOLD por defecto #}
    {% include 'partials/header.html.twig' with {'iconColor': juego == 'hsr' ? 'SILVER' : 'GOLD'} %}

    <main>
        <div class="container">
            <h1 class="form-title">Nueva Entrada: {{ juego == 'hsr' ? 'Honkai Star Rail' : 'Genshin Impact' }}</h1>

            {{ form_start(form, {'attr': {'novalidate': 'novalidate'}}) }}

            <div class="form-group">
                {{ form_label(form.titulo, 'Título del Post') }}
                {{ form_widget(form.titulo, {'attr': {'placeholder': 'Escribe un título...'}}) }}
            </div>

            <div class="form-group">
                {{ form_label(form.cuerpo, 'Contenido del Post') }}
                {{ form_widget(form.cuerpo, {'attr': {'class': 'editor-texto'}}) }}
            </div>

            <div class="submit-container">
                {{ form_widget(form.send, {
                    'attr': {'class': 'btn-submit'},
                    'label': 'Publicar en ' ~ (juego == 'hsr' ? 'HSR' : 'Genshin')
                }) }}
            </div>

            {{ form_end(form) }}
        </div>
    </main>

    <footer>
        Game Hub &copy; 2025-2026
    </footer>
{% endblock %}

{% block javascripts %}
    <script src="https://cdn.ckeditor.com/ckeditor5/40.0.0/classic/ckeditor.js"></script>
    <script>
        class MyUploadAdapter {
            constructor(loader) { this.loader = loader; }
            upload() {
                return this.loader.file.then(file => new Promise((resolve, reject) => {
                    this._initRequest();
                    this._initListeners(resolve, reject, file);
                    this._sendRequest(file);
                }));
            }
            abort() { if (this.xhr) { this.xhr.abort(); } }
            _initRequest() {
                const xhr = this.xhr = new XMLHttpRequest();
                xhr.open('POST', '{{ path('upload_post_image') }}', true);
                xhr.responseType = 'json';
            }
            _initListeners(resolve, reject, file) {
                const xhr = this.xhr;
                const genericErrorText = `No se pudo subir el archivo: ${file.name}.`;
                xhr.addEventListener('error', () => reject(genericErrorText));
                xhr.addEventListener('abort', () => reject());
                xhr.addEventListener('load', () => {
                    const response = xhr.response;
                    if (!response || response.error) return reject(response && response.error ? response.error.message : genericErrorText);
                    resolve({ default: response.url });
                });
            }
            _sendRequest(file) {
                const data = new FormData();
                data.append('upload', file);
                this.xhr.send(data);
            }
        }

        function MyCustomUploadAdapterPlugin(editor) {
            editor.plugins.get('FileRepository').createUploadAdapter = (loader) => new MyUploadAdapter(loader);
        }

        document.addEventListener("DOMContentLoaded", function() {
            const textarea = document.querySelector('.editor-texto');
            if (textarea) {
                ClassicEditor
                    .create(textarea, {
                        extraPlugins: [ MyCustomUploadAdapterPlugin ],
                        toolbar: [ 'heading', '|', 'bold', 'italic', 'link', 'bulletedList', 'numberedList', 'blockQuote', '|', 'uploadImage' ],
                        language: 'es'
                    })
                    .then(editor => {
                        editor.model.document.on('change:data', () => {
                            textarea.value = editor.getData();
                        });
                    })
                    .catch(error => console.error(error));
            }
        });
    </script>
{% endblock %}