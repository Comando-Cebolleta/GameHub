{% extends 'base.html.twig' %}

{% block title %}{{ post.titulo }}{% endblock %}

{% block stylesheets %}
    {% if juego == 'hsr' %}
        <link rel="stylesheet" href="{{ asset('css/styleBlogHONKAI.css') }}">
    {% else %}
        <link rel="stylesheet" href="{{ asset('css/styleBlogGENSHIN.css') }}">
    {% endif %}

    <link rel="stylesheet" href="{{ asset('css/styleSinglePost.css') }}">
    <link rel="stylesheet" href="{{ asset('css/styleLogin.css') }}">

    <style>
        .container { border-color: {{ juego == 'hsr' ? '#c0c0c0' : '#e0c080' }}; }
        .welcome-text { color: {{ juego == 'hsr' ? '#c0c0c0' : '#c2b46c' }}; }
        /* Ajuste de color dinámico para los bordes de comentarios */
        .comment { border-color: {{ juego == 'hsr' ? 'rgba(192,192,192,0.3)' : 'rgba(194,180,108,0.3)' }}; }
        .comment-header { color: {{ juego == 'hsr' ? '#c0c0c0' : '#c2b46c' }}; }
    </style>
{% endblock %}

{% block body %}
    {% include 'partials/header.html.twig' with {'iconColor': juego == 'hsr' ? 'SILVER' : 'GOLD'} %}

    <main>
        <div class="container">
            <article class="post-reading">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h1 class="post-header-title m-0">{{ post.titulo }}</h1>
                    <button id="like-btn" class="btn {{ isLiked ? 'btn-danger' : 'btn-outline-danger' }} d-flex align-items-center gap-2" data-post-id="{{ post.id }}">
                        <i id="like-icon" class="bi {{ isLiked ? 'bi-heart-fill' : 'bi-heart' }}"></i>
                        <span id="like-count">{{ post.likes|length }}</span>
                    </button>
                </div>

                <div class="post-full-content">
                    {{ post.cuerpo | sanitize_html('app.post_sanitizer') }}
                </div>

                <div class="back-container">
                    {% if juego == 'hsr' %}
                        <a href="{{ path('hsr_blog') }}" class="back-link">&larr; VOLVER AL BLOG HSR</a>
                    {% else %}
                        <a href="{{ path('genshin_blog') }}" class="back-link">&larr; VOLVER AL BLOG GENSHIN</a>
                    {% endif %}
                </div>

                <section class="comments-section">
                    <h2>Comentarios ({{ post.comentarios|length }})</h2>

                    <div class="comments-list">
                        {% for comentario in post.comentarios %}
                            <div class="comment">
                                <div class="comment-header">
                                    <strong>{{ comentario.user ? comentario.user.username : 'Anónimo' }}</strong>
                                    <span>{{ comentario.fechaPublicacion|date('d/m/Y H:i') }}</span>
                                </div>
                                <div class="comment-body">
                                    {{ comentario.cuerpo|nl2br }}
                                </div>
                            </div>
                        {% else %}
                            <p style="opacity: 0.6;">No hay comentarios todavía. ¡Sé el primero en comentar!</p>
                        {% endfor %}
                    </div>

                    {% if app.user %}
                        <div class="new-comment-form">
                            <h3>Deja un comentario</h3>
                            {{ form_start(commentForm) }}
                            <div class="form-group">
                                {{ form_widget(commentForm.cuerpo, {'attr': {'placeholder': 'Escribe tu comentario aquí...'}}) }}
                            </div>

                            {# 1. RENDERIZAMOS EL TOKEN DE SEGURIDAD (Sin esto no funciona) #}
                            {{ form_row(commentForm._token) }}

                            {# 2. NUESTRO BOTÓN #}
                            <button type="submit" class="btn-submit-comment" style="background: {{ juego == 'hsr' ? '#5a4b6e' : '#948459' }}; color: white;">
                                Publicar Comentario
                            </button>

                            {# 3. CERRAMOS SIN RENDERIZAR EL RESTO (Para que no salga el segundo botón) #}
                            {{ form_end(commentForm, {'render_rest': false}) }}
                        </div>
                    {% else %}
                        <div class="login-prompt">
                            <p>Debes <a href="{{ path('app_login') }}">iniciar sesión</a> para dejar un comentario.</p>
                        </div>
                    {% endif %}
                </section>
            </article>
        </div>
    </main>

    <footer>
        Game Hub &copy; 2025-2026
    </footer>
{% endblock %}

{% block javascripts %}
    <script src="{{ asset('js/like_system.js') }}"></script>
{% endblock %}